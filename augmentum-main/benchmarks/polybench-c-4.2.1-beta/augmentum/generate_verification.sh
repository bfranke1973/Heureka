#!/bin/bash
# Copyright (c) 2021, Bj√∂rn Franke
#
# This source code is licensed under the MIT license found in the
# LICENSE file in the root directory of this source tree.

BIN_DIR=$1
STL_WRAPPER_LIB=$2

USAGE="USAGE: $0 <path/to/polybench/binaries> <path/to/stl_wrapper.so>"

if [ -z $BIN_DIR ] || [ ! -d $BIN_DIR ]; then
    echo "No valid binary directory provided $BIN_DIR"
    echo $USAGE
    exit 1
fi

if [ -z ${STL_WRAPPER_LIB} ] || [ ! -f ${STL_WRAPPER_LIB} ]; then
    echo "No valid stl wrapper library provided ${STL_WRAPPER_LIB}"
    echo $USAGE
    exit 1
fi

printf "\n\n========= GENERATING REGULAR VERIFICATION ============================================\n"
OUT="benchmark_polybench_verification.gen"
printf "\"\"\"\nPolybench benchmark output for verification\n" > $OUT
printf "THIS CONTENT IS AUTOGENERATED FOR THE ${CLASS} PROBLEM SIZE!\n\"\"\"\n\n" >> $OUT
printf "POLYBENCH_OUT = {\n" >> $OUT

for t in `ls $BIN_DIR`; do
    NAME=`echo $t | cut -d '.' -f 1`
    printf "\nRunning $NAME ..."

    ${BIN_DIR}/${t} &> ${NAME}.out
    LD_PRELOAD=${STL_WRAPPER_LIB} ${BIN_DIR}/${t} &> ${NAME}_stlwrap.out

    # isolate wrapper output
    diff -u ${NAME}.out ${NAME}_stlwrap.out | grep '^\+' | grep -v '^++' | sed -E 's/^\+//' > ${NAME}_stlwrap_diff.out
    #diff --suppress-common-lines ${NAME}.out ${NAME}_stlwrap.out | grep ">" | cut -d ' ' -f 2-

    # search and replace pointer address with regex pattern
    sed -i -E 's/0x[0-9a-f]+/0x[0-9a-f]+/g' ${NAME}_stlwrap_diff.out

    # escape brackets
    sed -i -E 's/\)/\\)/g' ${NAME}_stlwrap_diff.out
    sed -i -E 's/\(/\\(/g' ${NAME}_stlwrap_diff.out


    printf "\t\"${NAME}\" : {\n" >> $OUT
    
    printf "\t\t\"REGULAR\" : \n\"\"\"" >> $OUT
    cat ${NAME}.out >> $OUT
    printf "\"\"\",\n\n" >> $OUT

    printf "\t\t\"WRAPPER\" : \nr\"\"\"" >> $OUT
    cat ${NAME}_stlwrap_diff.out >> $OUT
    printf "\"\"\"\n\n" >> $OUT
    
    printf "\t},\n" >> $OUT
done

printf "}\n#END OF AUTOGENERATED CONTENT" >> $OUT

printf "\nOutput generated in $OUT\n"
